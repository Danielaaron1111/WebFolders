<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy Customer Contact Management System</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --header-blue: #4A90E2;
            --light-blue: #E3F2FD;
            --border-gray: #ddd;
            --text-dark: #333;
            --sidebar-width: 260px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* ========== HEADER ========== */
        .app-header {
            background: var(--header-blue);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 50px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .app-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .header-controls button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .header-controls button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* ========== LOGIN PAGE ========== */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--header-blue) 0%, #2c5aa0 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }
        
        .login-box h2 {
            text-align: center;
            color: var(--header-blue);
            margin-bottom: 30px;
        }
        
        .login-box .form-control {
            margin-bottom: 15px;
            height: 45px;
        }
        
        .login-box .btn-primary {
            width: 100%;
            height: 45px;
            background: var(--header-blue);
            border: none;
            font-size: 16px;
        }
        
        /* ========== HOME PAGE ========== */
        .home-container {
            margin-top: 50px;
            display: flex;
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 50px;
            width: var(--sidebar-width);
            height: calc(100vh - 50px);
            background: white;
            border-right: 2px solid var(--border-gray);
            padding: 20px 15px;
            overflow-y: auto;
            z-index: 999;
        }
        
        .filter-section-title {
            font-size: 11px;
            font-weight: 700;
            color: #999;
            letter-spacing: 0.5px;
            margin: 20px 0 10px 0;
            text-transform: uppercase;
        }
        
        .filter-option {
            padding: 10px 12px;
            margin-bottom: 5px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        .filter-option:hover {
            background: var(--light-blue);
        }
        
        .filter-option.active {
            background: var(--header-blue);
            color: white;
            font-weight: 600;
        }
        
        .customer-count {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            font-weight: 600;
        }
        
        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px;
            width: calc(100% - var(--sidebar-width));
        }
        
        .search-bar {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .search-bar input {
            border: 1px solid var(--border-gray);
            border-radius: 6px;
            padding: 10px 15px;
            font-size: 14px;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 20px;
        }
        
        /* Customer List */
        .customer-list {
            padding: 15px;
            max-height: calc(100vh - 220px);
            overflow-y: auto;
        }
        
        .customer-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            padding-left: 20px;
        }
        
        .customer-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            border-radius: 8px 0 0 8px;
        }
        
        .customer-card.flag-emergency::before { background: #dc3545; }
        .customer-card.flag-daily::before { background: #9c27b0; }
        .customer-card.flag-email::before { background: #17a2b8; }
        .customer-card.flag-null::before { background: #6c757d; }
        
        .customer-card:hover {
            border-color: var(--header-blue);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.15);
        }
        
        .customer-card.selected {
            border-color: var(--header-blue);
            background: #f8f9ff;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);
        }
        
        .customer-name {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .customer-flag-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .customer-name h6 {
            margin: 0;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .customer-id-badge {
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #666;
            margin-left: auto;
        }
        
        .customer-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .customer-info div {
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .missed-badge {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            margin-top: 5px;
        }
        
        /* Brief Panel */
        .brief-panel {
            position: sticky;
            top: 70px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            max-height: calc(100vh - 90px);
            display: flex;
            flex-direction: column;
        }
        
        .brief-panel-header {
            background: var(--light-blue);
            padding: 15px;
            border-radius: 8px 8px 0 0;
            border-bottom: 2px solid var(--border-gray);
        }
        
        .brief-panel-header h5 {
            margin: 0;
            color: var(--header-blue);
            font-size: 16px;
            font-weight: 600;
        }
        
        .brief-panel-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .brief-panel.empty .brief-panel-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            padding: 60px 20px;
        }
        
        .brief-panel.empty .brief-panel-body i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .comm-item {
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        
        .comm-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .comm-type {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-dark);
        }
        
        .comm-date {
            font-size: 11px;
            color: #666;
        }
        
        .comm-preview {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .brief-actions {
            padding: 15px;
            border-top: 1px solid var(--border-gray);
            display: flex;
            gap: 10px;
        }
        
        .brief-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }
        
        /* Flag Dropdown in Brief Panel */
        .flag-selector {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        
        .flag-selector label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
            display: block;
        }
        
        .flag-selector select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-gray);
            border-radius: 6px;
            font-size: 13px;
        }
        
        /* Contact Selection Page */
        .contact-selection {
            max-width: 600px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .contact-selection h3 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--header-blue);
        }
        
        .contact-option {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .contact-option:hover {
            border-color: var(--header-blue);
            background: var(--light-blue);
        }
        
        .contact-option i {
            font-size: 32px;
            color: var(--header-blue);
            margin-bottom: 10px;
        }
        
        .contact-option h5 {
            margin: 0;
            color: var(--text-dark);
        }
        
        /* Call/Email Pages */
        .call-page, .email-page, .customer-file-page {
            padding: 20px;
            max-width: 1400px;
            margin: 70px auto 20px;
        }
        
        .page-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .page-header h3 {
            margin: 0 0 15px 0;
            color: var(--header-blue);
        }
        
        .customer-basic-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            font-size: 13px;
        }
        
        .customer-basic-info div {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .customer-basic-info strong {
            display: block;
            margin-bottom: 3px;
            color: #666;
            font-size: 11px;
        }
        
        .section-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .section-title {
            background: var(--light-blue);
            padding: 10px 15px;
            border-radius: 6px;
            margin: -20px -20px 15px -20px;
            font-size: 14px;
            font-weight: 600;
            color: var(--header-blue);
        }
        
        .two-column-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }
        
        .list-box {
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .list-item {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        .list-item:hover {
            background: var(--light-blue);
            border-color: var(--header-blue);
        }
        
        .list-item.active {
            background: var(--header-blue);
            color: white;
            border-color: var(--header-blue);
        }
        
        .list-item.current-rx {
            border-left: 4px solid #28a745;
        }
        
        .list-item.history-rx {
            border-left: 4px solid #6c757d;
        }
        
        .detail-box {
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            min-height: 400px;
            background: #fafafa;
        }
        
        .detail-box.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-style: italic;
        }
        
        .detail-section {
            margin-bottom: 20px;
        }
        
        .detail-section h6 {
            color: var(--header-blue);
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .detail-section p {
            margin: 0;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-dark);
        }
        
        .add-communication-form textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--border-gray);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }
        
        .add-communication-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-gray);
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 15px;
        }
        
        /* Responsive */
        @media (max-width: 1400px) {
            .content-grid { grid-template-columns: 1fr 380px; }
        }
        
        @media (max-width: 1200px) {
            .content-grid { grid-template-columns: 1fr 320px; }
            .brief-panel { width: 320px; }
        }
        
        @media (max-width: 992px) {
            .content-grid { grid-template-columns: 1fr; }
            .brief-panel { position: relative !important; top: 0 !important; width: 100%; }
            .two-column-layout { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="app-header">
        <div class="app-title">üíä Pharmacy Customer Contact Management</div>
        <div class="header-controls">
            <button onclick="logout()" id="logoutBtn" class="hidden">
                <i class="bi bi-box-arrow-right"></i> Logout
            </button>
            <button onclick="backToHome()" id="backBtn" class="hidden">
                <i class="bi bi-arrow-left"></i> Back to Home
            </button>
        </div>
    </div>

    <!-- PAGE 1: LOGIN -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h2>üîê Pharmacy Login</h2>
            <input type="text" class="form-control" placeholder="Username" value="admin">
            <input type="password" class="form-control" placeholder="Password" value="password">
            <button class="btn btn-primary" onclick="login()">
                <i class="bi bi-box-arrow-in-right"></i> Login
            </button>
        </div>
    </div>

    <!-- PAGE 2: HOME PAGE -->
    <div id="homePage" class="hidden">
        <div class="home-container">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="filter-section-title">FILTER BY STATUS</div>
                
                <div class="filter-option active" onclick="filterCustomers('all', event)">
                    <span>üìã</span>
                    <span>All Customers</span>
                </div>
                
                <div class="filter-option" onclick="filterCustomers('emergency', event)">
                    <span>üî¥</span>
                    <span>Emergency Calls</span>
                </div>
                
                <div class="filter-option" onclick="filterCustomers('email', event)">
                    <span>üìß</span>
                    <span>Email</span>
                </div>
                
                <div class="filter-option" onclick="filterCustomers('daily', event)">
                    <span>üü£</span>
                    <span>Daily Reminders</span>
                </div>
                
                <div class="customer-count">
                    <span id="customerCount">0 customers</span>
                    <button class="btn btn-sm btn-primary" onclick="showAddCustomerModal()">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <div class="search-bar">
                    <input type="text" class="form-control" id="searchInput" placeholder="üîç Search by ID, name..." onkeyup="searchCustomers()">
                </div>
                
                <div class="content-grid">
                    <div>
                        <div class="customer-list" id="customerList">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="brief-panel empty" id="briefPanel">
                        <div class="brief-panel-header">
                            <h5>Customer Details</h5>
                        </div>
                        <div class="brief-panel-body">
                            <i class="bi bi-hand-index"></i>
                            <p>Click a customer to view last 3 communications</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE 3: CONTACT SELECTION -->
    <div id="contactSelectionPage" class="hidden">
        <div class="contact-selection">
            <h3>Select Contact Type</h3>
            <div class="contact-option" onclick="goToCallPage()">
                <i class="bi bi-telephone-fill"></i>
                <h5>Call / Emergency Call</h5>
            </div>
            <div class="contact-option" onclick="goToEmailPage()">
                <i class="bi bi-envelope-fill"></i>
                <h5>Email</h5>
            </div>
        </div>
    </div>

    <!-- PAGE 4: CALL PAGE -->
    <div id="callPage" class="hidden call-page">
        <div class="page-header">
            <h3>üìû <span id="callCustomerName">Customer Name</span></h3>
            <div class="customer-basic-info">
                <div>
                    <strong>Phone</strong>
                    <span id="callPhone"></span>
                </div>
                <div>
                    <strong>Email</strong>
                    <span id="callEmail"></span>
                </div>
                <div>
                    <strong>Address</strong>
                    <span id="callAddress"></span>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <label style="font-size: 12px; font-weight: 600; color: #666; display: block; margin-bottom: 5px;">Label Customer:</label>
                <select class="form-select" id="callFlagSelect" onchange="updateCustomerFlag()">
                    <option value="emergency">üî¥ Emergency Call</option>
                    <option value="daily">üü£ Daily Reminder</option>
                    <option value="email">üìß Email</option>
                </select>
            </div>
        </div>
        
        <!-- Section 1: Follow-Up Contact -->
        <div class="section-box">
            <div class="section-title">üìã SECTION 1: FOLLOW-UP CONTACT (Prescriptions)</div>
            <div class="two-column-layout">
                <div class="list-box" id="callPrescriptionList">
                    <!-- Populated by JavaScript -->
                </div>
                <div class="detail-box empty" id="callPrescriptionDetail">
                    Click a prescription to view details
                </div>
            </div>
        </div>
        
        <!-- Section 2: Communication History -->
        <div class="section-box">
            <div class="section-title">üí¨ SECTION 2: COMMUNICATION HISTORY</div>
            <div class="two-column-layout">
                <div class="list-box" id="callCommList">
                    <!-- Populated by JavaScript -->
                </div>
                <div class="detail-box empty" id="callCommDetail">
                    Click a communication to view details
                </div>
            </div>
        </div>
        
        <!-- Section 3: Add New Communication -->
        <div class="section-box">
            <div class="section-title">‚ûï SECTION 3: ADD NEW COMMUNICATION</div>
            <div class="add-communication-form">
                <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Type:</label>
                <select id="newCommType">
                    <option value="Emergency Call">Emergency Call</option>
                    <option value="Daily Reminder Call">Daily Reminder Call</option>
                    <option value="Follow-up Call">Follow-up Call</option>
                </select>
                
                <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Purpose/Subject:</label>
                <input type="text" class="form-control mb-3" id="newCommPurpose" placeholder="Brief description...">
                
                <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Notes/Details:</label>
                <textarea id="newCommNotes" placeholder="Detailed notes about the communication..."></textarea>
                
                <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block; margin-top: 15px;">Outcome:</label>
                <input type="text" class="form-control mb-3" id="newCommOutcome" placeholder="Result of communication...">
                
                <button class="btn btn-primary w-100 mt-3" onclick="saveNewCommunication()">
                    <i class="bi bi-save"></i> Save Communication
                </button>
            </div>
        </div>
    </div>

    <!-- PAGE 5: EMAIL PAGE -->
    <div id="emailPage" class="hidden email-page">
        <div class="page-header">
            <h3>üìß <span id="emailCustomerName">Customer Name</span></h3>
        </div>
        
        <!-- Email Form -->
        <div class="section-box">
            <div class="section-title">‚úâÔ∏è SEND EMAIL</div>
            <div>
                <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">To:</label>
                <input type="text" class="form-control mb-3" id="emailTo" readonly>
                
                <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Subject:</label>
                <input type="text" class="form-control mb-3" id="emailSubject" placeholder="Email subject...">
                
                <label style="font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block;">Message:</label>
                <textarea class="form-control mb-3" id="emailMessage" rows="5" placeholder="Email message..."></textarea>
                
                <button class="btn btn-primary w-100" onclick="sendEmail()">
                    <i class="bi bi-send"></i> Send Email
                </button>
            </div>
        </div>
        
        <!-- Section 1: Communication History -->
        <div class="section-box">
            <div class="section-title">üí¨ SECTION 1: COMMUNICATION HISTORY</div>
            <div class="two-column-layout">
                <div class="list-box" id="emailCommList">
                    <!-- Populated by JavaScript -->
                </div>
                <div class="detail-box empty" id="emailCommDetail">
                    Click a communication to view details
                </div>
            </div>
        </div>
        
        <!-- Section 2: Prescription History -->
        <div class="section-box">
            <div class="section-title">üíä SECTION 2: PRESCRIPTION HISTORY</div>
            <div class="two-column-layout">
                <div class="list-box" id="emailPrescriptionList">
                    <!-- Populated by JavaScript -->
                </div>
                <div class="detail-box empty" id="emailPrescriptionDetail">
                    Click a prescription to view details
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE 6: CUSTOMER FILE -->
    <div id="customerFilePage" class="hidden customer-file-page">
        <div class="section-box">
            <div class="section-title">üë§ CUSTOMER INFORMATION</div>
            <div id="customerFileContent">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ========================================
        // STATE MANAGEMENT
        // ========================================
        
        let customers = [];
        let filteredCustomers = [];
        let selectedCustomerId = null;
        let currentFilter = 'all';
        
        // ========================================
        // DEFAULT CUSTOMER DATA (20 customers with variety)
        // ========================================
        
        const DEFAULT_CUSTOMERS = [
            // 5 customers WITHOUT flags (null)
            {
                id: 'C00001',
                firstName: 'Jennifer',
                lastName: 'Martinez',
                phone: '(780) 555-0101',
                email: 'jennifer.martinez@email.com',
                address: '123 Main St, Edmonton AB',
                flag: null,
                prescriptions: generatePrescriptions(6, 'current', 3),
                communications: generateCommunications(7)
            },
            {
                id: 'C00002',
                firstName: 'Robert',
                lastName: 'Thompson',
                phone: '(780) 555-0102',
                email: 'robert.thompson@email.com',
                address: '456 Oak Ave, Edmonton AB',
                flag: null,
                prescriptions: generatePrescriptions(8, 'current', 4),
                communications: generateCommunications(9)
            },
            {
                id: 'C00003',
                firstName: 'Amanda',
                lastName: 'Wilson',
                phone: '(780) 555-0103',
                email: 'amanda.wilson@email.com',
                address: '789 Pine Rd, Edmonton AB',
                flag: null,
                prescriptions: generatePrescriptions(5, 'current', 2),
                communications: generateCommunications(6)
            },
            {
                id: 'C00004',
                firstName: 'Michael',
                lastName: 'Brown',
                phone: '(780) 555-0104',
                email: 'michael.brown@email.com',
                address: '321 Elm St, Edmonton AB',
                flag: null,
                prescriptions: generatePrescriptions(7, 'current', 4),
                communications: generateCommunications(8)
            },
            {
                id: 'C00005',
                firstName: 'Lisa',
                lastName: 'Anderson',
                phone: '(780) 555-0105',
                email: 'lisa.anderson@email.com',
                address: '654 Maple Dr, Edmonton AB',
                flag: null,
                prescriptions: generatePrescriptions(9, 'current', 5),
                communications: generateCommunications(10)
            },
            
            // 5 customers with EMERGENCY flag
            {
                id: 'C00006',
                firstName: 'John',
                lastName: 'Smith',
                phone: '(780) 555-0106',
                email: 'john.smith@email.com',
                address: '111 River St, Edmonton AB',
                flag: 'emergency',
                prescriptions: generatePrescriptions(12, 'current', 6),
                communications: generateCommunications(15)
            },
            {
                id: 'C00007',
                firstName: 'Patricia',
                lastName: 'Garcia',
                phone: '(780) 555-0107',
                email: 'patricia.garcia@email.com',
                address: '222 Lake Ave, Edmonton AB',
                flag: 'emergency',
                prescriptions: generatePrescriptions(10, 'current', 5),
                communications: generateCommunications(12)
            },
            {
                id: 'C00008',
                firstName: 'David',
                lastName: 'Rodriguez',
                phone: '(780) 555-0108',
                email: 'david.rodriguez@email.com',
                address: '333 Hill Rd, Edmonton AB',
                flag: 'emergency',
                prescriptions: generatePrescriptions(14, 'current', 7),
                communications: generateCommunications(18)
            },
            {
                id: 'C00009',
                firstName: 'Mary',
                lastName: 'Martinez',
                phone: '(780) 555-0109',
                email: 'mary.martinez@email.com',
                address: '444 Valley Dr, Edmonton AB',
                flag: 'emergency',
                prescriptions: generatePrescriptions(11, 'current', 6),
                communications: generateCommunications(14)
            },
            {
                id: 'C00010',
                firstName: 'James',
                lastName: 'Lee',
                phone: '(780) 555-0110',
                email: 'james.lee@email.com',
                address: '555 Park Ln, Edmonton AB',
                flag: 'emergency',
                prescriptions: generatePrescriptions(13, 'current', 8),
                communications: generateCommunications(16)
            },
            
            // 5 customers with DAILY flag
            {
                id: 'C00011',
                firstName: 'Sarah',
                lastName: 'Johnson',
                phone: '(780) 555-0111',
                email: 'sarah.johnson@email.com',
                address: '666 Forest Ave, Edmonton AB',
                flag: 'daily',
                prescriptions: generatePrescriptions(8, 'current', 4),
                communications: generateCommunications(20)
            },
            {
                id: 'C00012',
                firstName: 'William',
                lastName: 'Davis',
                phone: '(780) 555-0112',
                email: 'william.davis@email.com',
                address: '777 Beach Rd, Edmonton AB',
                flag: 'daily',
                prescriptions: generatePrescriptions(9, 'current', 5),
                communications: generateCommunications(18)
            },
            {
                id: 'C00013',
                firstName: 'Linda',
                lastName: 'Miller',
                phone: '(780) 555-0113',
                email: 'linda.miller@email.com',
                address: '888 Mountain Dr, Edmonton AB',
                flag: 'daily',
                prescriptions: generatePrescriptions(10, 'current', 6),
                communications: generateCommunications(17)
            },
            {
                id: 'C00014',
                firstName: 'Richard',
                lastName: 'Wilson',
                phone: '(780) 555-0114',
                email: 'richard.wilson@email.com',
                address: '999 Desert Ln, Edmonton AB',
                flag: 'daily',
                prescriptions: generatePrescriptions(7, 'current', 3),
                communications: generateCommunications(15)
            },
            {
                id: 'C00015',
                firstName: 'Barbara',
                lastName: 'Moore',
                phone: '(780) 555-0115',
                email: 'barbara.moore@email.com',
                address: '1010 Ocean St, Edmonton AB',
                flag: 'daily',
                prescriptions: generatePrescriptions(11, 'current', 7),
                communications: generateCommunications(19)
            },
            
            // 5 customers with EMAIL flag
            {
                id: 'C00016',
                firstName: 'Thomas',
                lastName: 'Taylor',
                phone: '(780) 555-0116',
                email: 'thomas.taylor@email.com',
                address: '1111 Canyon Ave, Edmonton AB',
                flag: 'email',
                prescriptions: generatePrescriptions(6, 'current', 2),
                communications: generateCommunications(8)
            },
            {
                id: 'C00017',
                firstName: 'Elizabeth',
                lastName: 'Anderson',
                phone: '(780) 555-0117',
                email: 'elizabeth.anderson@email.com',
                address: '1212 Prairie Rd, Edmonton AB',
                flag: 'email',
                prescriptions: generatePrescriptions(12, 'current', 6),
                communications: generateCommunications(13)
            },
            {
                id: 'C00018',
                firstName: 'Christopher',
                lastName: 'Thomas',
                phone: '(780) 555-0118',
                email: 'christopher.thomas@email.com',
                address: '1313 Meadow Dr, Edmonton AB',
                flag: 'email',
                prescriptions: generatePrescriptions(9, 'current', 5),
                communications: generateCommunications(11)
            },
            {
                id: 'C00019',
                firstName: 'Nancy',
                lastName: 'Jackson',
                phone: '(780) 555-0119',
                email: 'nancy.jackson@email.com',
                address: '1414 Garden Ln, Edmonton AB',
                flag: 'email',
                prescriptions: generatePrescriptions(15, 'current', 8),
                communications: generateCommunications(16)
            },
            {
                id: 'C00020',
                firstName: 'Daniel',
                lastName: 'White',
                phone: '(780) 555-0120',
                email: 'daniel.white@email.com',
                address: '1515 Sunset Ave, Edmonton AB',
                flag: 'email',
                prescriptions: generatePrescriptions(10, 'current', 5),
                communications: generateCommunications(12)
            }
        ];
        
        // ========================================
        // HELPER FUNCTIONS TO GENERATE DATA
        // ========================================
        
        const MEDICATIONS = [
            'Metformin 500mg', 'Lisinopril 10mg', 'Atorvastatin 20mg', 'Levothyroxine 50mcg',
            'Amlodipine 5mg', 'Omeprazole 20mg', 'Losartan 50mg', 'Gabapentin 300mg',
            'Sertraline 50mg', 'Albuterol Inhaler', 'Warfarin 5mg', 'Furosemide 40mg',
            'Aspirin 81mg', 'Clopidogrel 75mg', 'Insulin Glargine', 'Prednisone 10mg'
        ];
        
        function generatePrescriptions(total, currentCount, historyCount) {
            const prescriptions = [];
            
            // Current prescriptions
            for (let i = 0; i < currentCount; i++) {
                const med = MEDICATIONS[i % MEDICATIONS.length];
                prescriptions.push({
                    id: `RX${String(prescriptions.length + 1).padStart(3, '0')}`,
                    medication: med,
                    status: 'current',
                    dosage: `Take ${Math.floor(Math.random() * 3) + 1} tablet(s) ${['daily', 'twice daily', 'three times daily'][Math.floor(Math.random() * 3)]}`,
                    sideEffects: 'May cause nausea, dizziness, headache, or stomach upset. Contact doctor if symptoms persist.',
                    contraindications: 'Do not use if allergic to this medication, pregnant, or have severe liver/kidney disease.',
                    interactions: 'May interact with alcohol, NSAIDs, blood thinners, and certain antibiotics. Consult pharmacist.',
                    warnings: '‚ö†Ô∏è Take with food. Avoid driving if dizzy. Monitor for allergic reactions. Keep out of reach of children.'
                });
            }
            
            // History prescriptions
            for (let i = 0; i < historyCount; i++) {
                const med = MEDICATIONS[(currentCount + i) % MEDICATIONS.length];
                prescriptions.push({
                    id: `RX${String(prescriptions.length + 1).padStart(3, '0')}`,
                    medication: med,
                    status: 'history',
                    dosage: `Take ${Math.floor(Math.random() * 2) + 1} tablet(s) daily`,
                    sideEffects: 'Caused stomach irritation and nausea.',
                    contraindications: 'Not suitable for patients with gastric ulcers.',
                    interactions: 'Interacted poorly with patient\'s blood pressure medication.',
                    warnings: 'Discontinued due to adverse effects.',
                    startDate: '2023-01-15',
                    endDate: '2024-11-30',
                    discontinuedReason: ['Side effects', 'Switched to alternative', 'No longer needed'][Math.floor(Math.random() * 3)]
                });
            }
            
            return prescriptions;
        }
        
        function generateCommunications(count) {
            const communications = [];
            const types = ['Emergency Call', 'Daily Reminder Call', 'Follow-up Call', 'Email'];
            const staffMembers = ['Clerk_JD', 'Clerk_AM', 'Clerk_PM', 'System_Auto'];
            
            for (let i = 0; i < count; i++) {
                const daysAgo = count - i;
                const date = new Date();
                date.setDate(date.getDate() - daysAgo);
                
                const type = types[Math.floor(Math.random() * types.length)];
                const isEmail = type === 'Email';
                
                communications.push({
                    id: `COMM${String(i + 1).padStart(3, '0')}`,
                    date: date.toISOString().split('T')[0],
                    time: `${Math.floor(Math.random() * 12) + 8}:${['00', '15', '30', '45'][Math.floor(Math.random() * 4)]} ${['AM', 'PM'][Math.floor(Math.random() * 2)]}`,
                    type: type,
                    contactMethod: isEmail ? 'Email' : 'Phone',
                    staff: isEmail && Math.random() > 0.5 ? 'System_Auto' : staffMembers[Math.floor(Math.random() * staffMembers.length)],
                    purpose: isEmail ? 'Daily medication reminder' : ['Routine check-in', 'Follow-up on side effects', 'Prescription refill reminder', 'Emergency consultation'][Math.floor(Math.random() * 4)],
                    notes: isEmail ? 
                        'Automated email reminder sent about daily medications.' :
                        ['Customer reported feeling better after medication adjustment.', 
                         'Discussed potential side effects and when to call doctor.',
                         'Customer requested refill, approved by pharmacist.',
                         'Emergency consultation regarding severe reaction.'][Math.floor(Math.random() * 4)],
                    outcome: ['Resolved', 'Follow-up scheduled', 'Referred to doctor', 'No action needed'][Math.floor(Math.random() * 4)],
                    duration: isEmail ? 'N/A' : `${Math.floor(Math.random() * 20) + 5} minutes`
                });
            }
            
            return communications.reverse(); // Most recent first
        }
        
        // ========================================
        // INITIALIZATION
        // ========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            loadFromLocalStorage();
        });
        
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('pharmacyCustomersSimple');
            if (saved) {
                try {
                    customers = JSON.parse(saved);
                } catch (e) {
                    customers = [...DEFAULT_CUSTOMERS];
                    saveToLocalStorage();
                }
            } else {
                customers = [...DEFAULT_CUSTOMERS];
                saveToLocalStorage();
            }
        }
        
        function saveToLocalStorage() {
            localStorage.setItem('pharmacyCustomersSimple', JSON.stringify(customers));
        }
        
        // ========================================
        // LOGIN & NAVIGATION
        // ========================================
        
        function login() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            filterCustomers('all');
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                document.getElementById('homePage').classList.add('hidden');
                document.getElementById('callPage').classList.add('hidden');
                document.getElementById('emailPage').classList.add('hidden');
                document.getElementById('customerFilePage').classList.add('hidden');
                document.getElementById('contactSelectionPage').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.add('hidden');
                document.getElementById('backBtn').classList.add('hidden');
                selectedCustomerId = null;
            }
        }
        
        function backToHome() {
            document.getElementById('callPage').classList.add('hidden');
            document.getElementById('emailPage').classList.add('hidden');
            document.getElementById('customerFilePage').classList.add('hidden');
            document.getElementById('contactSelectionPage').classList.add('hidden');
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('backBtn').classList.add('hidden');
        }
        
        // ========================================
        // HOME PAGE - CUSTOMER LIST
        // ========================================
        
        function filterCustomers(filter, event) {
            document.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('active'));
            if (event) event.currentTarget.classList.add('active');
            
            currentFilter = filter;
            
            if (filter === 'all') {
                filteredCustomers = [...customers];
            } else {
                filteredCustomers = customers.filter(c => c.flag === filter);
            }
            
            renderCustomerList();
        }
        
        function searchCustomers() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (query === '') {
                filterCustomers(currentFilter);
                return;
            }
            
            let baseList = currentFilter === 'all' ? customers : customers.filter(c => c.flag === currentFilter);
            
            filteredCustomers = baseList.filter(c =>
                c.id.toLowerCase().includes(query) ||
                c.firstName.toLowerCase().includes(query) ||
                c.lastName.toLowerCase().includes(query) ||
                `${c.firstName} ${c.lastName}`.toLowerCase().includes(query)
            );
            
            renderCustomerList();
        }
        
        function renderCustomerList() {
            const container = document.getElementById('customerList');
            let html = '';
            
            filteredCustomers.forEach(customer => {
                const selected = customer.id === selectedCustomerId ? 'selected' : '';
                const flagClass = customer.flag ? `flag-${customer.flag}` : 'flag-null';
                const flagColor = getFlagColor(customer.flag);
                
                html += `
                    <div class="customer-card ${flagClass} ${selected}" onclick="selectCustomer('${customer.id}')">
                        <div class="customer-name">
                            <span class="customer-flag-dot" style="background: ${flagColor}"></span>
                            <h6>${customer.lastName}, ${customer.firstName}</h6>
                            <span class="customer-id-badge">${customer.id}</span>
                        </div>
                        <div class="customer-info">
                            <div><i class="bi bi-telephone"></i> ${customer.phone}</div>
                            <div><i class="bi bi-envelope"></i> ${customer.email}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-center text-muted p-4">No customers found</p>';
            document.getElementById('customerCount').textContent = `${filteredCustomers.length} customers`;
        }
        
        function getFlagColor(flag) {
            const colors = {
                'emergency': '#dc3545',
                'daily': '#9c27b0',
                'email': '#17a2b8',
                'null': '#6c757d'
            };
            return colors[flag] || '#6c757d';
        }
        
        function selectCustomer(customerId) {
            selectedCustomerId = customerId;
            const customer = customers.find(c => c.id === customerId);
            
            renderCustomerList();
            
            // Show last 3 communications in brief panel
            const briefPanel = document.getElementById('briefPanel');
            briefPanel.classList.remove('empty');
            
            const last3 = customer.communications.slice(0, 3);
            
            let html = '';
            last3.forEach(comm => {
                html += `
                    <div class="comm-item">
                        <div class="comm-item-header">
                            <span class="comm-type">${getCommIcon(comm.type)} ${comm.type}</span>
                            <span class="comm-date">${comm.date}</span>
                        </div>
                        <div class="comm-preview">${comm.notes.substring(0, 60)}...</div>
                    </div>
                `;
            });
            
            // Flag selector
            html += `
                <div class="flag-selector">
                    <label>Label Customer:</label>
                    <select class="form-select" onchange="updateCustomerFlagFromHome(this.value)">
                        <option value="emergency" ${customer.flag === 'emergency' ? 'selected' : ''}>üî¥ Emergency Call</option>
                        <option value="daily" ${customer.flag === 'daily' ? 'selected' : ''}>üü£ Daily Reminder</option>
                        <option value="email" ${customer.flag === 'email' ? 'selected' : ''}>üìß Email</option>
                    </select>
                </div>
            `;
            
            briefPanel.querySelector('.brief-panel-body').innerHTML = html;
            
            // Add action buttons
            briefPanel.innerHTML += `
                <div class="brief-actions">
                    <button class="btn btn-primary" onclick="goToContactSelection()">
                        <i class="bi bi-telephone"></i> Contact
                    </button>
                    <button class="btn btn-outline-primary" onclick="goToCustomerFile()">
                        <i class="bi bi-person"></i> Customer File
                    </button>
                </div>
            `;
        }
        
        function getCommIcon(type) {
            if (type.includes('Emergency')) return 'üö®';
            if (type.includes('Daily')) return 'üü£';
            if (type.includes('Email')) return 'üìß';
            return 'üìû';
        }
        
        function updateCustomerFlagFromHome(newFlag) {
            if (!selectedCustomerId) return;
            
            const customer = customers.find(c => c.id === selectedCustomerId);
            customer.flag = newFlag;
            saveToLocalStorage();
            
            // Refresh display
            filterCustomers(currentFilter);
            selectCustomer(selectedCustomerId);
            
            alert(`‚úÖ Customer flagged as: ${newFlag.toUpperCase()}`);
        }
        
        // ========================================
        // NAVIGATION TO OTHER PAGES
        // ========================================
        
        function goToContactSelection() {
            if (!selectedCustomerId) return;
            
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('contactSelectionPage').classList.remove('hidden');
            document.getElementById('backBtn').classList.remove('hidden');
        }
        
        function goToCallPage() {
            if (!selectedCustomerId) return;
            
            const customer = customers.find(c => c.id === selectedCustomerId);
            
            document.getElementById('contactSelectionPage').classList.add('hidden');
            document.getElementById('callPage').classList.remove('hidden');
            
            // Populate call page
            document.getElementById('callCustomerName').textContent = `${customer.firstName} ${customer.lastName}`;
            document.getElementById('callPhone').textContent = customer.phone;
            document.getElementById('callEmail').textContent = customer.email;
            document.getElementById('callAddress').textContent = customer.address;
            document.getElementById('callFlagSelect').value = customer.flag || 'emergency';
            
            renderCallPrescriptions(customer);
            renderCallCommunications(customer);
        }
        
        function goToEmailPage() {
            if (!selectedCustomerId) return;
            
            const customer = customers.find(c => c.id === selectedCustomerId);
            
            document.getElementById('contactSelectionPage').classList.add('hidden');
            document.getElementById('emailPage').classList.remove('hidden');
            
            // Populate email page
            document.getElementById('emailCustomerName').textContent = `${customer.firstName} ${customer.lastName}`;
            document.getElementById('emailTo').value = customer.email;
            document.getElementById('emailSubject').value = '';
            document.getElementById('emailMessage').value = '';
            
            renderEmailCommunications(customer);
            renderEmailPrescriptions(customer);
        }
        
        function goToCustomerFile() {
            if (!selectedCustomerId) return;
            
            const customer = customers.find(c => c.id === selectedCustomerId);
            
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('customerFilePage').classList.remove('hidden');
            document.getElementById('backBtn').classList.remove('hidden');
            
            // Show all customer info
            let html = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div><strong>Name:</strong> ${customer.firstName} ${customer.lastName}</div>
                    <div><strong>ID:</strong> ${customer.id}</div>
                    <div><strong>Phone:</strong> ${customer.phone}</div>
                    <div><strong>Email:</strong> ${customer.email}</div>
                    <div><strong>Address:</strong> ${customer.address}</div>
                    <div><strong>Flag:</strong> ${customer.flag ? customer.flag.toUpperCase() : 'NOT FLAGGED'}</div>
                </div>
                <hr>
                <h5>Prescriptions (${customer.prescriptions.length})</h5>
                <ul>
                    ${customer.prescriptions.map(p => `<li>${p.medication} - ${p.status.toUpperCase()}</li>`).join('')}
                </ul>
                <hr>
                <h5>Communications (${customer.communications.length})</h5>
                <ul>
                    ${customer.communications.map(c => `<li>${c.date} - ${c.type}: ${c.notes.substring(0, 50)}...</li>`).join('')}
                </ul>
            `;
            
            document.getElementById('customerFileContent').innerHTML = html;
        }
        
        // ========================================
        // CALL PAGE FUNCTIONS
        // ========================================
        
        function renderCallPrescriptions(customer) {
            const listContainer = document.getElementById('callPrescriptionList');
            let html = '';
            
            customer.prescriptions.forEach((rx, index) => {
                const itemClass = rx.status === 'current' ? 'current-rx' : 'history-rx';
                const label = rx.status === 'current' ? '‚úÖ CURRENT' : 'üìã HISTORY';
                html += `
                    <div class="list-item ${itemClass}" onclick="showCallPrescriptionDetail(${index})">
                        <strong>${rx.medication}</strong><br>
                        <small style="color: #666;">${label}</small>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function showCallPrescriptionDetail(index) {
            const customer = customers.find(c => c.id === selectedCustomerId);
            const rx = customer.prescriptions[index];
            
            // Highlight selected
            document.querySelectorAll('#callPrescriptionList .list-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
            
            const detailBox = document.getElementById('callPrescriptionDetail');
            detailBox.classList.remove('empty');
            
            let html = `
                <div class="detail-section">
                    <h5 style="color: var(--header-blue); margin-bottom: 15px;">${rx.medication}</h5>
                    <p style="background: #e3f2fd; padding: 8px; border-radius: 4px; font-weight: 600;">
                        ${rx.status === 'current' ? '‚úÖ CURRENT PRESCRIPTION' : 'üìã PRESCRIPTION HISTORY'}
                    </p>
                </div>
                
                <div class="detail-section">
                    <h6>üíä DOSAGE</h6>
                    <p>${rx.dosage}</p>
                </div>
                
                <div class="detail-section">
                    <h6>ü§¢ SIDE EFFECTS</h6>
                    <p>${rx.sideEffects}</p>
                </div>
                
                <div class="detail-section">
                    <h6>‚ö†Ô∏è CONTRAINDICATIONS</h6>
                    <p>${rx.contraindications}</p>
                </div>
                
                <div class="detail-section">
                    <h6>‚ö° DRUG INTERACTIONS</h6>
                    <p>${rx.interactions}</p>
                </div>
                
                <div class="detail-section">
                    <h6>üö® WARNINGS</h6>
                    <p>${rx.warnings}</p>
                </div>
            `;
            
            if (rx.status === 'history') {
                html += `
                    <div class="detail-section">
                        <h6>üìÖ DATES</h6>
                        <p><strong>Start:</strong> ${rx.startDate || 'N/A'}<br>
                        <strong>End:</strong> ${rx.endDate || 'N/A'}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h6>üìù REASON FOR DISCONTINUATION</h6>
                        <p>${rx.discontinuedReason || 'N/A'}</p>
                    </div>
                `;
            }
            
            detailBox.innerHTML = html;
        }
        
        function renderCallCommunications(customer) {
            const listContainer = document.getElementById('callCommList');
            let html = '';
            
            customer.communications.forEach((comm, index) => {
                html += `
                    <div class="list-item" onclick="showCallCommDetail(${index})">
                        <strong>${getCommIcon(comm.type)} ${comm.date} - ${comm.type}</strong><br>
                        <small style="color: #666;">${comm.notes.substring(0, 40)}...</small>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function showCallCommDetail(index) {
            const customer = customers.find(c => c.id === selectedCustomerId);
            const comm = customer.communications[index];
            
            // Highlight selected
            document.querySelectorAll('#callCommList .list-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
            
            const detailBox = document.getElementById('callCommDetail');
            detailBox.classList.remove('empty');
            
            detailBox.innerHTML = `
                <div class="detail-section">
                    <h6>üìÖ DATE</h6>
                    <p>${comm.date} at ${comm.time}</p>
                </div>
                
                <div class="detail-section">
                    <h6>üìû TYPE</h6>
                    <p>${comm.type}</p>
                </div>
                
                <div class="detail-section">
                    <h6>üë§ CONTACT METHOD</h6>
                    <p>${comm.contactMethod}</p>
                </div>
                
                <div class="detail-section">
                    <h6>üëî STAFF</h6>
                    <p>${comm.staff}</p>
                </div>
                
                <div class="detail-section">
                    <h6>üéØ PURPOSE</h6>
                    <p>${comm.purpose}</p>
                </div>
                
                <div class="detail-section">
                    <h6>üìù NOTES</h6>
                    <p>${comm.notes}</p>
                </div>
                
                <div class="detail-section">
                    <h6>‚úÖ OUTCOME</h6>
                    <p>${comm.outcome}</p>
                </div>
                
                <div class="detail-section">
                    <h6>‚è±Ô∏è DURATION</h6>
                    <p>${comm.duration}</p>
                </div>
            `;
        }
        
        function updateCustomerFlag() {
            if (!selectedCustomerId) return;
            
            const newFlag = document.getElementById('callFlagSelect').value;
            const customer = customers.find(c => c.id === selectedCustomerId);
            customer.flag = newFlag;
            saveToLocalStorage();
            
            alert(`‚úÖ Customer flag updated to: ${newFlag.toUpperCase()}`);
        }
        
        function saveNewCommunication() {
            if (!selectedCustomerId) return;
            
            const customer = customers.find(c => c.id === selectedCustomerId);
            const type = document.getElementById('newCommType').value;
            const purpose = document.getElementById('newCommPurpose').value.trim();
            const notes = document.getElementById('newCommNotes').value.trim();
            const outcome = document.getElementById('newCommOutcome').value.trim();
            
            if (!purpose || !notes) {
                alert('‚ùå Please fill in Purpose and Notes fields');
                return;
            }
            
            const newComm = {
                id: `COMM${String(customer.communications.length + 1).padStart(3, '0')}`,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                type: type,
                contactMethod: 'Phone',
                staff: 'Clerk_Current',
                purpose: purpose,
                notes: notes,
                outcome: outcome || 'Pending',
                duration: '5 minutes'
            };
            
            customer.communications.unshift(newComm);
            saveToLocalStorage();
            
            // Clear form
            document.getElementById('newCommPurpose').value = '';
            document.getElementById('newCommNotes').value = '';
            document.getElementById('newCommOutcome').value = '';
            
            // Refresh display
            renderCallCommunications(customer);
            
            alert('‚úÖ Communication added to history!');
        }
        
        // ========================================
        // EMAIL PAGE FUNCTIONS
        // ========================================
        
        function renderEmailCommunications(customer) {
            const listContainer = document.getElementById('emailCommList');
            let html = '';
            
            customer.communications.forEach((comm, index) => {
                html += `
                    <div class="list-item" onclick="showEmailCommDetail(${index})">
                        <strong>${getCommIcon(comm.type)} ${comm.date} - ${comm.type}</strong><br>
                        <small style="color: #666;">${comm.notes.substring(0, 40)}...</small>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function showEmailCommDetail(index) {
            const customer = customers.find(c => c.id === selectedCustomerId);
            const comm = customer.communications[index];
            
            document.querySelectorAll('#emailCommList .list-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
            
            const detailBox = document.getElementById('emailCommDetail');
            detailBox.classList.remove('empty');
            
            detailBox.innerHTML = `
                <div class="detail-section">
                    <h6>üìÖ DATE</h6>
                    <p>${comm.date} at ${comm.time}</p>
                </div>
                
                <div class="detail-section">
                    <h6>üìû TYPE</h6>
                    <p>${comm.type}</p>
                </div>
                
                <div class="detail-section">
                    <h6>üë§ CONTACT METHOD</h6>
                    <p>${comm.contactMethod}</p>
                </div>
                
                <div class="detail-section">
                    <h6>üëî STAFF</h6>
                    <p>${comm.staff}</p>
                </div>
                
                <div class="detail-section">
                    <h6>üéØ PURPOSE</h6>
                    <p>${comm.purpose}</p>
                </div>
                
                <div class="detail-section">
                    <h6>üìù NOTES</h6>
                    <p>${comm.notes}</p>
                </div>
                
                <div class="detail-section">
                    <h6>‚úÖ OUTCOME</h6>
                    <p>${comm.outcome}</p>
                </div>
            `;
        }
        
        function renderEmailPrescriptions(customer) {
            const listContainer = document.getElementById('emailPrescriptionList');
            let html = '';
            
            customer.prescriptions.forEach((rx, index) => {
                const itemClass = rx.status === 'current' ? 'current-rx' : 'history-rx';
                const label = rx.status === 'current' ? '‚úÖ CURRENT' : 'üìã HISTORY';
                html += `
                    <div class="list-item ${itemClass}" onclick="showEmailPrescriptionDetail(${index})">
                        <strong>${rx.medication}</strong><br>
                        <small style="color: #666;">${label}</small>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function showEmailPrescriptionDetail(index) {
            const customer = customers.find(c => c.id === selectedCustomerId);
            const rx = customer.prescriptions[index];
            
            document.querySelectorAll('#emailPrescriptionList .list-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
            
            const detailBox = document.getElementById('emailPrescriptionDetail');
            detailBox.classList.remove('empty');
            
            let html = `
                <div class="detail-section">
                    <h5 style="color: var(--header-blue); margin-bottom: 15px;">${rx.medication}</h5>
                    <p style="background: #e3f2fd; padding: 8px; border-radius: 4px; font-weight: 600;">
                        ${rx.status === 'current' ? '‚úÖ CURRENT PRESCRIPTION' : 'üìã PRESCRIPTION HISTORY'}
                    </p>
                </div>
                
                <div class="detail-section">
                    <h6>üíä DOSAGE</h6>
                    <p>${rx.dosage}</p>
                </div>
                
                <div class="detail-section">
                    <h6>ü§¢ SIDE EFFECTS</h6>
                    <p>${rx.sideEffects}</p>
                </div>
                
                <div class="detail-section">
                    <h6>‚ö†Ô∏è CONTRAINDICATIONS</h6>
                    <p>${rx.contraindications}</p>
                </div>
                
                <div class="detail-section">
                    <h6>‚ö° DRUG INTERACTIONS</h6>
                    <p>${rx.interactions}</p>
                </div>
                
                <div class="detail-section">
                    <h6>üö® WARNINGS</h6>
                    <p>${rx.warnings}</p>
                </div>
            `;
            
            if (rx.status === 'history') {
                html += `
                    <div class="detail-section">
                        <h6>üìÖ DATES</h6>
                        <p><strong>Start:</strong> ${rx.startDate || 'N/A'}<br>
                        <strong>End:</strong> ${rx.endDate || 'N/A'}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h6>üìù REASON FOR DISCONTINUATION</h6>
                        <p>${rx.discontinuedReason || 'N/A'}</p>
                    </div>
                `;
            }
            
            detailBox.innerHTML = html;
        }
        
        function sendEmail() {
            if (!selectedCustomerId) return;
            
            const customer = customers.find(c => c.id === selectedCustomerId);
            const subject = document.getElementById('emailSubject').value.trim();
            const message = document.getElementById('emailMessage').value.trim();
            
            if (!subject || !message) {
                alert('‚ùå Please fill in Subject and Message fields');
                return;
            }
            
            const newComm = {
                id: `COMM${String(customer.communications.length + 1).padStart(3, '0')}`,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                type: 'Email',
                contactMethod: 'Email',
                staff: 'Clerk_Current',
                purpose: subject,
                notes: message,
                outcome: 'Email sent successfully',
                duration: 'N/A'
            };
            
            customer.communications.unshift(newComm);
            saveToLocalStorage();
            
            // Clear form
            document.getElementById('emailSubject').value = '';
            document.getElementById('emailMessage').value = '';
            
            // Refresh display
            renderEmailCommunications(customer);
            
            alert('‚úÖ Email sent and added to communication history!');
        }
        
        // ========================================
        // DUMMY FUNCTIONS (not implemented yet)
        // ========================================
        
        function showAddCustomerModal() {
            alert('Add Customer functionality - To be implemented');
        }
        
    </script>
</body>
</html>
